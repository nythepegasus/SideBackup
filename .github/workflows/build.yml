name: Build SideBackup

on:
  push:
    branches:
      - '**'
    tags:
      - '*.*.*'

jobs:
  build:
    name: Build and Archive
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install Xcode
        uses: maxim-lobanov/setup-xcode@v1.6.0
        with:
          xcode-version: latest-stable

      - name: Determine Build Type
        id: build_type
        run: |
          if [[ "${GITHUB_REF}" == ref/tags/* ]]; then
            echo "type=release" >> $GITHUB_OUTPUT
          else
            echo "type=nightly" >> $GITHUB_OUTPUT
          fi

      - uses: irgaly/xcode-cache@v1.9.2
        with:
          key: xcode-cache-deriveddata-${{ github.workflow }}-${{ github.sha }}
          restore-keys: xcode-cache-dereviddata-${{ github.workflow }}-

      - name: Build
        run: ./.github/makeipa ${{ steps.build_type.outputs.type }}

      - name: Get Artifacts
        id: artifacts
        run: |
          echo "ipa=$(basename build/*ipa)" >> $GITHUB_OUTPUT
          echo "log=$(basename build/*log*)" >> $GITHUB_OUTPUT
          echo "sym=$(basename build/*SYM*)" >> $GITHUB_OUTPUT

      - name: Upload IPA
        uses: actions/upload-artifact@v6
        with:
          name: ${{ steps.artifacts.outputs.ipa }}
          path: build/*ipa
          compression-level: 0

      - name: Upload Build Log
        uses: actions/upload-artifact@v6
        with:
          name: ${{ steps.artifacts.outputs.log }}
          path: build/*log*
          compression-level: 0

      - name: Upload dSYM
        uses: actions/upload-artifact@v6
        with:
          name: ${{ steps.artifacts.outputs.sym }}
          path: build/*SYM*
          compression-level: 0

      - name: Upload nightly
        if: steps.build_type.outputs.type == 'nightly'
        uses: altemiq/update-existing-release@v1.3.5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          release: nightly
          tag: nightly
          replace: true
          prerelease: true
          files: >
            build/${{ steps.artifacts.outputs.log }}
            build/${{ steps.artifacts.outputs.sym }}
            build/${{ steps.artifacts.outputs.ipa }}
          body: |
            Automated nightly build from commit ${{ github.sha }}

            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.event.head_commit.message }}
            **Built:** ${{ github.event.head_commit.timestamp }}

      - name: Upload Release
        if: steps.build_type.outputs.type == 'release'
        uses: softprops/action-gh-release@v2.5.0
        with:
          files: |
            build/${{ steps.artifacts.outputs.log }}
            build/${{ steps.artifacts.outputs.sym }}
            build/${{ steps.artifacts.outputs.ipa }}
          draft: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
